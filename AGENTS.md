# obsidian-vault-mcp — Agent Specification

Minimal MCP server for AI agents to log insights and decisions during development.
Runs headless on a Mini PC (Proxmox LXC), writes to an Obsidian Vault mounted via rclone.

## Philosophy

**Write-focused, not read-heavy.**

The server's job is to be a reliable, structured write endpoint. Agents log what they
discover and decide as they work. Reading, synthesizing, and acting on those logs happens
on Obsidian-equipped machines (Mac).

| Concern | Where |
|---------|-------|
| Log insights and decisions during dev | This server (any device with MCP access) |
| Read, summarize, task management | Obsidian on Mac |

## Architecture

```
AI Agent (Claude Code, etc.)
  ↓ MCP Streamable HTTP  (port 1065)
Bun MCP Server  (src/index.ts)              ← Mini PC / LXC (headless)
  controller/   ← MCP tool registration + Zod schema (1 tool = 1 file)
  usecase/      ← path resolution, business logic
  repository/   ← raw fs operations
  ↓ fs
VAULT_PATH  (rclone mount → Google Drive / Obsidian Vault)
```

## Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `VAULT_PATH` | yes | — | Absolute path to the vault root on the server |
| `PORT` | no | `1065` | HTTP port to listen on |

## Vault Structure

`VAULT_PATH` should point to the `claude/` subdirectory of your Obsidian Vault (not the vault root).

```
Obsidian Vault/
└── claude/                        ← VAULT_PATH points here
    └── {repository_name}/         ← git repo name (e.g. "md-append-mcp")
        ├── devlog/
        │   └── {session_id}.md    ← e.g. 20260221-1423.md (one file per session)
        └── adr/
            ├── _index.md
            └── ADR-{NNN}-{slug}.md
```

`repository_name` = the git repository name. All tool paths are scoped under
`VAULT_PATH/{repository_name}/`.

## Tools

### `devlog_append`

Append structured log entries to a session devlog file.

```typescript
input: {
  repository_name: string,
  session_id: string,       // "YYYYMMDD-HHMM" — generated by skill at session start
  entries: Array<{
    type: "problem" | "impl" | "verify" | "insight",
    content: string,
    resolution?: string,    // problem only: how was it resolved (or "未解決")
    branch?: string         // optional git branch name for context
  }>
}
output: { appended: number, created: boolean }
```

- Server injects current `HH:MM` timestamp for each entry.
- If `devlog/{session_id}.md` does not exist, creates it with frontmatter:
  `{ tags: ["devlog"], session, repository, date }`.
- Entry format: `[impl]    14:32  content`
- Problem format: `[problem] 14:45  issue → resolution`

### `devlog_tail`

Read the last N entries from a session devlog.

```typescript
input: {
  repository_name: string,
  session_id: string,
  n?: number               // default: 20
}
output: { entries: string[], path: string }
```

### `adr_write`

Create a new ADR. Auto-assigns the next sequential number.

```typescript
input: {
  repository_name: string,
  title: string,
  content: string,          // max 500 chars — keep ADRs concise
  branch?: string,
  status?: "proposed" | "accepted",   // default: "accepted"
  related?: string[]        // GitHub URLs
}
output: { number: number, path: string }
```

- Scans `adr/` to determine the next ADR number.
- Creates `adr/ADR-{NNN}-{slug}.md` with frontmatter:
  `{ tags: ["adr", status], adr: N, date, repository, branch, related }`.
- Appends a row to `adr/_index.md` (creates if missing).
- Rejects if `content.length > 500`.

### `adr_delete`

Delete an ADR by number.

```typescript
input: {
  repository_name: string,
  number: number
}
output: { deleted: boolean, path: string }
```

Note: does not update `_index.md` (index may become stale — acceptable).

### `adr_index`

List all ADRs for a repository.

```typescript
input: { repository_name: string }
output: { adrs: Array<{ number: number, slug: string, path: string }> }
```

### `adr_view`

Read a specific ADR.

```typescript
input: {
  repository_name: string,
  number: number
}
output: { content: string, path: string }
```

## Security

- No authentication in the server itself (auth-agnostic by design).
- Network-layer security delegated to Tailscale or Cloudflare Zero Trust.
- Path traversal (`..`) blocked in `resolveSafePath()`.
